---
sidebar:
nav: "main"
layout: single
title:  "멀티 쓰레딩 적용 개발일기"
categories: [Programming,Dev-diary]
tags: [Java,Dev-diary]
teaser: /assets/images/teaser/java.jpeg
---

<p align="center"><img src="/assets/images/teaser/programming.jpeg" width="100%" height="auto"></p>

이번 포스팅은 주니어로써 멀티쓰레딩을 회사에 적용한 경험에 대한 포스팅입니다.(21년 9월에 배정받은 업무입니다.)\
당시 개발할때 발표한 발표자료와 회사코드에 주석을 작성했던것이 큰 도움이 되었네요.\
(기록의 중요성)


그래서 멀티스레딩 -> 
멀티스레딩은 이런식으로 적용해서 해결 ->
aop프록시 한계회피용으로 async서비스는 왜 만들었는지


해결 해야하는 문제
---
자사서비스에서 동영상을 처리할때 외부 비디오 서비스를 사용하였습니다.\
해당 비디오 서비스API는 영상 등록의 경우 API응답까지 대기시간이 꽤 있었습니다.\
(영상을 InputStream으로 변환 -> InputStream으로 영상 등록 API호출 -> 응답대기후 응답에 따라 처리)\
평소엔 별 문제가 없었지만 순간적으로 많은 영상을 등록 처리해야 할때 문제가 발생하였습니다.\
이럴경우 첫번째 영상등록 API호출 -> 두번째 영상등록 API호출 -> 세번째 ··· 같이 처리되어(동기처리) 뒤로 밀린 영상들의 경우 영상등록이 너무 늦어지는 현상이 생겼습니다.\
또한 해당 비디오 서비스에서 하나의 계정에서 영상변환을 최대 3개까지만 동시에 처리하였습니다.\
즉 영상이 더 많이 올 경우를 대비해 <u> **여러 계정에 순차적으로 영상을 병렬처리하여 등록** </u>해야했습니다.


요구사항 분석 및 해결 방안
---
핵심적인 요구사항은 다음과 같습니다.

- 영상 등록 API호출 후 응답대기시간을 줄여야한다.
  - 영상 호출 자체를 병렬적으로 처리하여 동시에 등록 후 응답을 대기하였습니다.
  - 병렬처리를 위해 멀티쓰레딩을 적용하였었습니다.
  - 영상의 응답을 DB업데이트 이후 서버에서 사용하지 않기때문에 응답을 받은 쓰레드에서 직접 DB에 업데이트 하였습니다.
    - 영상에 대한 PK가 있기때문에 쓰레드에서 바로 업데이트처리 하여도 무방하다고 생각하였습니다. (ps. 아직 등록 전이라 해당 영상을 다른 로직에서 사용하지 않는 상태)
    - DB접근으로는 MyBatis를 사용하였으며 기술이사님께 질문하여 MyBatis의 SqlSessionTemplate의 부분을 설정하여 쓰레드 세이프하게 사용가능 확인하였습니다.\
      (아직 맡은 업무를 JPA로 전환하기 전 개발일기입니다.)
  
  
      
- 들어오는 영상을 여러 계정에 하나씩 처리해야합니다.
  > A계정토큰, B계정토큰, C계정토큰이 있다고 가정합니다.\
  > 등록해야 될 영상이 10개 일경우 토큰을 가져와 영상등록을 합니다.\
  > 각 영상등록시 호출 순서에 따라 계정 토큰들이 발급됩니다.\
  > ex 10개일시 A,B,C,A,B,C,A,B,C,A\
  > 그 후 다음 영상 등록요청이 3개가 왔습니다.\
  > 다시 토큰을 가져와 영상을 등록합니다. 이경우 B, C, A의 순서로 토큰이 발급되어야합니다.\
  > 즉 애플리케이션서버가 종료되기 전까진 영상의 순서에따라 토큰을 발급합니다.
  - 외부 비디오서비스 계정정보를 관리하는 싱글턴객체를 만들었습니다.(이하 TokenInjector)
  - 해당 싱글턴객체에서 메서드(이하 getToken())를 이용하여 계정정보를 가져옵니디.
  - TokenInjector에서 영상이 호출될때 영상호출에 대한 횟수를 카운트하여 계정토큰enum에서 순서를 계산하여 가져왔습니다.\
    (지금와서 생각해보면 큐 자료구조를 이용하면 훨씬 더 문제를 쉽게 해결 할 수 있어보이네요.)
  - 프로젝트의 DB설계상 상품의 이미지와 영상을 같은 테이블에서 관리하였기때문에 DB를 이용하여 영상의 순서를 파악하는것은 비효율적이라 생각하였습니다.\
    추가로 영상 등록시마다 DB커넥션을 사용해야하는것도 비효율적이라 생각해서 싱글턴객체를 사용하여 관리하였습니다.
    
    

멀티쓰레딩 적용기
---


적용 후 문제
---


문제점 해결? (자가호출 회피)
---